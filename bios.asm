start:
	mov	sp, 0x9000
	mov	ss, sp

	xor     ax, ax
	mov     es, ax
	mov     cx, 8
empty:
	mov     bx, cx
	shl     bx, 2
	mov     word [es:bx], blank
	add     bx, 2
	mov     [es:bx], cs
	inc     cx
	cmp     cx, 0x1e
	jne     empty

	mov     word [es:0x10*4], int10
	mov     [es:0x10*4+2], cs

	mov     word [es:0x12*4], int12
	mov     [es:0x12*4+2], cs

	mov     word [es:0x13*4], int13
	mov     [es:0x13*4+2], cs

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	mov	ax, 3
	int	0x10

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	xor	ax, ax
	mov	es, ax
	mov	ax, 0x0201
	mov	bx, 0x7c00
	mov	cx, 1
	mov	dx, 0x0080
	int	0x13

	jmp	0:0x7c00

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

int10:
	cmp	ah, 0
	je	set_video_mode
	cmp	ah, 0x0e
	je	putchar
	iret
set_video_mode:
	push	ax
	push	bx
	push	cx
	push	dx
	push	es
	push	ds
	push	di
	push	si

	mov     bx, cs
	mov     ds, bx

	cmp	al, 0x03
	je	v03
	cmp	al, 0x0d
	je	v0d
	iret
v03:
	mov     si, video03
	jmp	vga_misc
v0d:
	mov	si, video0d
	jmp	vga_misc

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

vga_misc:
	lodsb
	mov     dx, 0x3c2
	out     dx, al

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	xor     bl, bl
	mov     cx, 0x15
vga_attr:
	mov     dx, 0x3da
	in      al, dx
	mov     al, bl
	inc     bl
	mov     dx, 0x3c0
	out     dx, al
	lodsb
	out     dx, al
	loop    vga_attr

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	xor     bx, bx
	mov     cx, 5
vga_seq:
	mov     al, bl
	inc     bl
	mov     dx, 0x3c4
	out     dx, al
	lodsb
	inc     dx
	out     dx, al
	loop    vga_seq

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	xor     bl, bl
	mov     cx, 9
vga_gc:
	mov     al, bl
	inc     bl
	mov     dx, 0x3ce
	out     dx, al
	lodsb
	inc     dx
	out     dx, al
	loop    vga_gc

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	mov     dx, 0x3d4
	mov     al, 0x11
	out     dx, al
	inc     dx
	xor     al, al
	out     dx, al

	xor     bl, bl
	mov     cx, 0x19
vga_crtc:
	mov     al, bl
	mov     dx, 0x3d4
	out     dx, al
	inc     bl
	lodsb
	inc     dx
	out     dx, al
	loop    vga_crtc

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

vga_enable_video:
	mov     al, 0x20
	mov     dx, 0x3c0
	out     dx, al

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	mov	dx, 0x3ce
	mov	al, 5
	out	dx, al
	inc	dx
	mov	al, 0
	out	dx, al

	dec	dx
	mov	al, 6
	out	dx, al
	inc	dx
	mov	al, 4
	out	dx, al

	mov	dx, 0x3c4
	mov	al, 2
	out	dx, al
	inc	dx
	mov	al, 4
	out	dx, al

	dec	dx
	mov	al, 4
	out	dx, al
	inc	dx
	mov	al, 6
	out	dx, al

	mov	bx, cs
	mov	ds, bx
	mov	si, font

	mov	bx, 0xa000
	mov	es, bx
	xor	di, di

	mov	cx, 128
loadfont:
	%rep 8
		lodsb
		stosb
		stosb
	%endrep
	times 16 inc di
	loop	loadfont

	mov	dx, 0x3c4
	mov	al, 2
	out	dx, al
	inc	dx
	mov	al, 3
	out	dx, al

	dec	dx
	mov	al, 4
	out	dx, al
	inc	dx
	mov	al, 2
	out	dx, al

	mov	dx, 0x3ce
	mov	al, 5
	out	dx, al
	inc	dx
	mov	al, 0x10
	out	dx, al

	dec	dx
	mov	al, 6
	out	dx, al
	inc	dx
	mov	al, 0x0e
	out	dx, al

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

	mov	cx, 16
	mov	ax, cs
	mov	ds, ax
	mov	si, palette
load_palette:
	mov	al, 16
	sub	al, cl
	mov	dx, 0x3c8
	out	dx, al
	mov	dx, 0x3c9
	outsb
	outsb
	outsb
	loop	load_palette
	pop	si
	pop	di
	pop	ds
	pop	es
	pop	dx
	pop	cx
	pop	bx
	pop	ax
	iret
putchar:
	push	ax
	push	bx
	push	es
	push	di
	mov	bx, 0x40		; BIOS data area (255 bytes)
	mov	es, bx
	mov	di, [es:0]
	mov	bx, 0xb800
	mov	es, bx
	mov	ah, 7
	stosw
	mov	bx, 0x40
	mov	es, bx
	mov	[es:0], di
	pop	di
	pop	es
	pop	bx
	pop	ax
	iret

int12:
	mov	ax, 640
	iret

int13:
	cmp	ah, 2
	je	read_disk
	cmp	ah, 8
	je	disk_type
	iret
read_disk:
	push	ax
	push	bx
	push	cx
	push	dx
	push	di

	mov	di, bx                 ; target = es:bx
	mov	bl, al

	mov     al, dh                 ; head
	or      al, 0xa0
	mov     dx, 0x1f6
	out     dx, al

	mov     dx, 0x1f2
	mov	al, bl                 ; sectors to read
	out     dx, al

	mov     dx, 0x1f3
	mov     al, cl                 ; sector (1-63)
	out     dx, al

	mov     dx, 0x1f4
	mov     al, ch                 ; cylinder (0-255)
	out     dx, al

	mov     dx, 0x1f7
	mov     al, 0x20               ; issue read (0x30 for write)
	out     dx, al
repeat:
	mov     dx, 0x1f7
processing:
	in      al, dx
	test    al, 8
	jz      processing
	mov     cx, 256
	mov     dx, 0x1f0
	rep     insw                   ; read cx words from port dx to es:di
	dec     bl
	cmp     bl, 0
	jne     repeat                 ; until sectors are read

	pop	di
	pop	dx
	pop	cx
	pop	bx
	pop	ax
	iret

disk_type:
        mov     ch, 3     ; +3
        mov     cl, 64    ; +256 (259 cylinders)
        add     cl, 63    ; sectors/track (63)
        mov     dh, 15    ; heads (16)
        mov     dl, 1

blank:
	iret

;;;;;;;; ;;;;;;;; ;;;;;;;; ;;;;;;;;

video03:
misc03:
	db 0x67
attr03:
	db 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07
	db 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f
        db 0x0c, 0x00, 0x0f, 0x08, 0x00
seq03:
	db 0x03, 0x00, 0x03, 0x00, 0x02
gc03:
	db 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0e, 0x0f
	db 0xff
crtc03:
	db 0x5f, 0x4f, 0x50, 0x82, 0x55, 0x81, 0xbf, 0x1f
	db 0x00, 0x4f, 0x0d, 0x0e, 0x00, 0x00, 0x00, 0x00
	db 0x9c, 0x8e, 0x8f, 0x28, 0x1f, 0x96, 0xb9, 0xff
	db 0xff

video0d:
misc0d:
	db 0x63
attr0d:
	db 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07
	db 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17
	db 0x01, 0x00, 0x0f, 0x00, 0x00
seq0d:
	db 0x00, 0x09, 0x0f, 0x00, 0x02
gc0d:
	db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x0f
	db 0xff
crtc0d:
	db 0x2d, 0x27, 0x28, 0x90, 0x2b, 0x80, 0xbf, 0x1f
	db 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	db 0x9c, 0x8e, 0x8f, 0x14, 0x00, 0x96, 0xb9, 0xff
	db 0xff

palette:
	db 0x00, 0x00, 0x00 ; black
	db 0x00, 0x00, 0x2a ; blue
	db 0x00, 0x2a, 0x00 ; green
	db 0x00, 0x2a, 0x2a ; cyan
	db 0x2a, 0x00, 0x00 ; red
	db 0x2a, 0x00, 0x2a ; magenta
	db 0x2a, 0x15, 0x00 ; brown
	db 0x2a, 0x2a, 0x2a ; light gray
	db 0x15, 0x15, 0x15 ; dark gray
	db 0x15, 0x15, 0x3f ; light blue
	db 0x15, 0x3f, 0x15 ; light green
	db 0x15, 0x3f, 0x3f ; light cyan
	db 0x3f, 0x15, 0x15 ; light red
	db 0x3f, 0x15, 0x3f ; light magenta
	db 0x3f, 0x3f, 0x15 ; yellow
	db 0x3f, 0x3f, 0x3f ; white

times	0xfa6e-($-$$) db 0

font:
	db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	db 0x7e, 0x81, 0xa5, 0x81, 0xbd, 0x99, 0x81, 0x7e
	db 0x7e, 0xff, 0xdb, 0xff, 0xc3, 0xe7, 0xff, 0x7e
	db 0x6c, 0xfe, 0xfe, 0xfe, 0x7c, 0x38, 0x10, 0x00
	db 0x10, 0x38, 0x7c, 0xfe, 0x7c, 0x38, 0x10, 0x00
	db 0x38, 0x7c, 0x38, 0xfe, 0xfe, 0x7c, 0x38, 0x7c
	db 0x10, 0x10, 0x38, 0x7c, 0xfe, 0x7c, 0x38, 0x7c
	db 0x00, 0x00, 0x18, 0x3c, 0x3c, 0x18, 0x00, 0x00
	db 0xff, 0xff, 0xe7, 0xc3, 0xc3, 0xe7, 0xff, 0xff
	db 0x00, 0x3c, 0x66, 0x42, 0x42, 0x66, 0x3c, 0x00
	db 0xff, 0xc3, 0x99, 0xbd, 0xbd, 0x99, 0xc3, 0xff
	db 0x0f, 0x07, 0x0f, 0x7d, 0xcc, 0xcc, 0xcc, 0x78
	db 0x3c, 0x66, 0x66, 0x66, 0x3c, 0x18, 0x7e, 0x18
	db 0x3f, 0x33, 0x3f, 0x30, 0x30, 0x70, 0xf0, 0xe0
	db 0x7f, 0x63, 0x7f, 0x63, 0x63, 0x67, 0xe6, 0xc0
	db 0x99, 0x5a, 0x3c, 0xe7, 0xe7, 0x3c, 0x5a, 0x99
	db 0x80, 0xe0, 0xf8, 0xfe, 0xf8, 0xe0, 0x80, 0x00
	db 0x02, 0x0e, 0x3e, 0xfe, 0x3e, 0x0e, 0x02, 0x00
	db 0x18, 0x3c, 0x7e, 0x18, 0x18, 0x7e, 0x3c, 0x18
	db 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x66, 0x00
	db 0x7f, 0xdb, 0xdb, 0x7b, 0x1b, 0x1b, 0x1b, 0x00
	db 0x3e, 0x63, 0x38, 0x6c, 0x6c, 0x38, 0xcc, 0x78
	db 0x00, 0x00, 0x00, 0x00, 0x7e, 0x7e, 0x7e, 0x00
	db 0x18, 0x3c, 0x7e, 0x18, 0x7e, 0x3c, 0x18, 0xff
	db 0x18, 0x3c, 0x7e, 0x18, 0x18, 0x18, 0x18, 0x00
	db 0x18, 0x18, 0x18, 0x18, 0x7e, 0x3c, 0x18, 0x00
	db 0x00, 0x18, 0x0c, 0xfe, 0x0c, 0x18, 0x00, 0x00
	db 0x00, 0x30, 0x60, 0xfe, 0x60, 0x30, 0x00, 0x00
	db 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xfe, 0x00, 0x00
	db 0x00, 0x24, 0x66, 0xff, 0x66, 0x24, 0x00, 0x00
	db 0x00, 0x18, 0x3c, 0x7e, 0xff, 0xff, 0x00, 0x00
	db 0x00, 0xff, 0xff, 0x7e, 0x3c, 0x18, 0x00, 0x00
	db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	db 0x30, 0x78, 0x78, 0x30, 0x30, 0x00, 0x30, 0x00
	db 0x6c, 0x6c, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00
	db 0x6c, 0x6c, 0xfe, 0x6c, 0xfe, 0x6c, 0x6c, 0x00
	db 0x30, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x30, 0x00
	db 0x00, 0xc6, 0xcc, 0x18, 0x30, 0x66, 0xc6, 0x00
	db 0x38, 0x6c, 0x38, 0x76, 0xdc, 0xcc, 0x76, 0x00
	db 0x60, 0x60, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00
	db 0x18, 0x30, 0x60, 0x60, 0x60, 0x30, 0x18, 0x00
	db 0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00
	db 0x00, 0x66, 0x3c, 0xff, 0x3c, 0x66, 0x00, 0x00
	db 0x00, 0x30, 0x30, 0xfc, 0x30, 0x30, 0x00, 0x00
	db 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x60
	db 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00
	db 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00
	db 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00
	db 0x7c, 0xc6, 0xce, 0xde, 0xf6, 0xe6, 0x7c, 0x00
	db 0x30, 0x70, 0x30, 0x30, 0x30, 0x30, 0xfc, 0x00
	db 0x78, 0xcc, 0x0c, 0x38, 0x60, 0xcc, 0xfc, 0x00
	db 0x78, 0xcc, 0x0c, 0x38, 0x0c, 0xcc, 0x78, 0x00
	db 0x1c, 0x3c, 0x6c, 0xcc, 0xfe, 0x0c, 0x1e, 0x00
	db 0xfc, 0xc0, 0xf8, 0x0c, 0x0c, 0xcc, 0x78, 0x00
	db 0x38, 0x60, 0xc0, 0xf8, 0xcc, 0xcc, 0x78, 0x00
	db 0xfc, 0xcc, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x00
	db 0x78, 0xcc, 0xcc, 0x78, 0xcc, 0xcc, 0x78, 0x00
	db 0x78, 0xcc, 0xcc, 0x7c, 0x0c, 0x18, 0x70, 0x00
	db 0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00
	db 0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x60
	db 0x18, 0x30, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x00
	db 0x00, 0x00, 0xfc, 0x00, 0x00, 0xfc, 0x00, 0x00
	db 0x60, 0x30, 0x18, 0x0c, 0x18, 0x30, 0x60, 0x00
	db 0x78, 0xcc, 0x0c, 0x18, 0x30, 0x00, 0x30, 0x00
	db 0x7c, 0xc6, 0xde, 0xde, 0xde, 0xc0, 0x78, 0x00
	db 0x30, 0x78, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0x00
	db 0xfc, 0x66, 0x66, 0x7c, 0x66, 0x66, 0xfc, 0x00
	db 0x3c, 0x66, 0xc0, 0xc0, 0xc0, 0x66, 0x3c, 0x00
	db 0xf8, 0x6c, 0x66, 0x66, 0x66, 0x6c, 0xf8, 0x00
	db 0xfe, 0x62, 0x68, 0x78, 0x68, 0x62, 0xfe, 0x00
	db 0xfe, 0x62, 0x68, 0x78, 0x68, 0x60, 0xf0, 0x00
	db 0x3c, 0x66, 0xc0, 0xc0, 0xce, 0x66, 0x3e, 0x00
	db 0xcc, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0xcc, 0x00
	db 0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00
	db 0x1e, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78, 0x00
	db 0xe6, 0x66, 0x6c, 0x78, 0x6c, 0x66, 0xe6, 0x00
	db 0xf0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xfe, 0x00
	db 0xc6, 0xee, 0xfe, 0xfe, 0xd6, 0xc6, 0xc6, 0x00
	db 0xc6, 0xe6, 0xf6, 0xde, 0xce, 0xc6, 0xc6, 0x00
	db 0x38, 0x6c, 0xc6, 0xc6, 0xc6, 0x6c, 0x38, 0x00
	db 0xfc, 0x66, 0x66, 0x7c, 0x60, 0x60, 0xf0, 0x00
	db 0x78, 0xcc, 0xcc, 0xcc, 0xdc, 0x78, 0x1c, 0x00
	db 0xfc, 0x66, 0x66, 0x7c, 0x6c, 0x66, 0xe6, 0x00
	db 0x78, 0xcc, 0xe0, 0x70, 0x1c, 0xcc, 0x78, 0x00
	db 0xfc, 0xb4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00
	db 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xfc, 0x00
	db 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00
	db 0xc6, 0xc6, 0xc6, 0xd6, 0xfe, 0xee, 0xc6, 0x00
	db 0xc6, 0xc6, 0x6c, 0x38, 0x38, 0x6c, 0xc6, 0x00
	db 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x30, 0x78, 0x00
	db 0xfe, 0xc6, 0x8c, 0x18, 0x32, 0x66, 0xfe, 0x00
	db 0x78, 0x60, 0x60, 0x60, 0x60, 0x60, 0x78, 0x00
	db 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x02, 0x00
	db 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x78, 0x00
	db 0x10, 0x38, 0x6c, 0xc6, 0x00, 0x00, 0x00, 0x00
	db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff
	db 0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00
	db 0x00, 0x00, 0x78, 0x0c, 0x7c, 0xcc, 0x76, 0x00
	db 0xe0, 0x60, 0x60, 0x7c, 0x66, 0x66, 0xdc, 0x00
	db 0x00, 0x00, 0x78, 0xcc, 0xc0, 0xcc, 0x78, 0x00
	db 0x1c, 0x0c, 0x0c, 0x7c, 0xcc, 0xcc, 0x76, 0x00
	db 0x00, 0x00, 0x78, 0xcc, 0xfc, 0xc0, 0x78, 0x00
	db 0x38, 0x6c, 0x60, 0xf0, 0x60, 0x60, 0xf0, 0x00
	db 0x00, 0x00, 0x76, 0xcc, 0xcc, 0x7c, 0x0c, 0xf8
	db 0xe0, 0x60, 0x6c, 0x76, 0x66, 0x66, 0xe6, 0x00
	db 0x30, 0x00, 0x70, 0x30, 0x30, 0x30, 0x78, 0x00
	db 0x0c, 0x00, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78
	db 0xe0, 0x60, 0x66, 0x6c, 0x78, 0x6c, 0xe6, 0x00
	db 0x70, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00
	db 0x00, 0x00, 0xcc, 0xfe, 0xfe, 0xd6, 0xc6, 0x00
	db 0x00, 0x00, 0xf8, 0xcc, 0xcc, 0xcc, 0xcc, 0x00
	db 0x00, 0x00, 0x78, 0xcc, 0xcc, 0xcc, 0x78, 0x00
	db 0x00, 0x00, 0xdc, 0x66, 0x66, 0x7c, 0x60, 0xf0
	db 0x00, 0x00, 0x76, 0xcc, 0xcc, 0x7c, 0x0c, 0x1e
	db 0x00, 0x00, 0xdc, 0x76, 0x66, 0x60, 0xf0, 0x00
	db 0x00, 0x00, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x00
	db 0x10, 0x30, 0x7c, 0x30, 0x30, 0x34, 0x18, 0x00
	db 0x00, 0x00, 0xcc, 0xcc, 0xcc, 0xcc, 0x76, 0x00
	db 0x00, 0x00, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00
	db 0x00, 0x00, 0xc6, 0xd6, 0xfe, 0xfe, 0x6c, 0x00
	db 0x00, 0x00, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0x00
	db 0x00, 0x00, 0xcc, 0xcc, 0xcc, 0x7c, 0x0c, 0xf8
	db 0x00, 0x00, 0xfc, 0x98, 0x30, 0x64, 0xfc, 0x00
	db 0x1c, 0x30, 0x30, 0xe0, 0x30, 0x30, 0x1c, 0x00
	db 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00
	db 0xe0, 0x30, 0x30, 0x1c, 0x30, 0x30, 0xe0, 0x00
	db 0x76, 0xdc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	db 0x00, 0x10, 0x38, 0x6c, 0xc6, 0xc6, 0xfe, 0x00

times   0xfff0-($-$$) db 0

	jmp     0xf000:start

times   0x10000-($-$$) db 0
